<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ねこだま的インベーダーゲーム</title>
    <style>
        body {
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: 'Courier New', Courier, monospace;
        }
        canvas {
            background-color: black;
            border: 2px solid #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }
        .controls {
            margin-top: 10px;
            text-align: center;
        }
    </style>
</head>
<body>

    <h1>ねこだま的 スペースインベーダー</h1>
    <canvas id="gameCanvas" width="600" height="400"></canvas>
    <div class="controls">
        <p>操作方法: [←][→] 移動 | [SPACE] 発射</p>
        <p id="status">スペースキーを押してスタート</p>
    </div>

<script>
    // --- 設定と変数 ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const statusText = document.getElementById('status');

    // ゲームの状態
    let gameState = 'START'; // START, PLAYING, GAMEOVER
    let score = 0;
    
// ★追加：画像の読み込み
    const playerImage = new Image();
    playerImage.src = 'neko_jyuwomotutyaneko1.png'; // 画像のファイル名に合わせてください

    // プレイヤー設定（サイズを画像に合わせて調整）
    const player = {
        x: canvas.width / 2 - 20, // 幅が増えた分、開始位置を調整
        y: canvas.height - 50,    // 画像の高さに合わせて少し上に配置
        width: 40,                // 画像の幅（好みのサイズに）
        height: 40,               // 画像の高さ
        speed: 5,
        color: '#00ff00',         // 画像を使うので色は無視されますが残しておきます
        bullets: []
    };

    // 敵（インベーダー）設定
    const enemyRows = 4;
    const enemyCols = 8;
    const enemyWidth = 30;
    const enemyHeight = 20;
    const enemyPadding = 15;
    const enemyOffsetTop = 30;
    const enemyOffsetLeft = 30;
    let enemies = [];
    let enemyDirection = 1; // 1: 右, -1: 左
    let enemySpeed = 1; // ゲームが進むと速くする

    // キー入力管理
    const keys = {
        Right: false,
        Left: false,
        Space: false
    };

    // --- イベントリスナー ---
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') keys.Right = true;
        if (e.key === 'ArrowLeft') keys.Left = true;
        if (e.key === ' ') {
            if (gameState === 'START' || gameState === 'GAMEOVER') {
                resetGame();
                gameState = 'PLAYING';
            } else {
                keys.Space = true;
                shootBullet();
            }
        }
    });

    document.addEventListener('keyup', (e) => {
        if (e.key === 'ArrowRight') keys.Right = false;
        if (e.key === 'ArrowLeft') keys.Left = false;
        if (e.key === ' ') keys.Space = false;
    });

    // --- ゲームロジック ---

    // ゲーム初期化
    function resetGame() {
        score = 0;
        player.x = canvas.width / 2 - 15;
        player.bullets = [];
        enemySpeed = 1; // 初期スピード
        enemyDirection = 1;
        createEnemies();
        statusText.innerText = `SCORE: ${score}`;
    }

    // 敵の生成
    function createEnemies() {
        enemies = [];
        for (let c = 0; c < enemyCols; c++) {
            for (let r = 0; r < enemyRows; r++) {
                const enemyX = (c * (enemyWidth + enemyPadding)) + enemyOffsetLeft;
                const enemyY = (r * (enemyHeight + enemyPadding)) + enemyOffsetTop;
                enemies.push({ x: enemyX, y: enemyY, status: 1 });
            }
        }
    }

    // 弾の発射
    function shootBullet() {
        // 連射制限（画面内に3発まで）
        if (player.bullets.length < 3) {
            player.bullets.push({
                x: player.x + player.width / 2 - 2,
                y: player.y,
                width: 4,
                height: 10,
                speed: 7
            });
        }
    }

    // 更新処理
    function update() {
        if (gameState !== 'PLAYING') return;

        // プレイヤー移動
        if (keys.Right && player.x < canvas.width - player.width) {
            player.x += player.speed;
        }
        if (keys.Left && player.x > 0) {
            player.x -= player.speed;
        }

        // 弾の移動
        for (let i = 0; i < player.bullets.length; i++) {
            player.bullets[i].y -= player.bullets[i].speed;
            // 画面外に出たら削除
            if (player.bullets[i].y < 0) {
                player.bullets.splice(i, 1);
                i--;
            }
        }

        // 敵の移動ロジック
        let edgeTouched = false;
        
        // 生きている敵の中で、画面端に達したかチェック
        for (let i = 0; i < enemies.length; i++) {
            if (enemies[i].status === 1) {
                if (enemies[i].x + enemyWidth > canvas.width && enemyDirection === 1) {
                    edgeTouched = true;
                } else if (enemies[i].x < 0 && enemyDirection === -1) {
                    edgeTouched = true;
                }
            }
        }

        // 端に達していたら折り返し＆一段下げる
        if (edgeTouched) {
            enemyDirection *= -1;
            for (let i = 0; i < enemies.length; i++) {
                enemies[i].y += 10;
                // ゲームオーバー判定（敵がプレイヤーの位置まで降りてきた）
                if (enemies[i].y + enemyHeight >= player.y) {
                    gameOver();
                }
            }
            // 少しスピードアップ
            enemySpeed += 0.2;
        }

        // 通常移動
        for (let i = 0; i < enemies.length; i++) {
            enemies[i].x += enemySpeed * enemyDirection;
        }

        // 当たり判定（弾 vs 敵）
        for (let i = 0; i < player.bullets.length; i++) {
            for (let j = 0; j < enemies.length; j++) {
                const b = player.bullets[i];
                const e = enemies[j];
                
                if (e.status === 1) {
                    if (b.x > e.x && b.x < e.x + enemyWidth &&
                        b.y > e.y && b.y < e.y + enemyHeight) {
                            e.status = 0; // 敵消滅
                            player.bullets.splice(i, 1); // 弾消滅
                            i--;
                            score += 10;
                            statusText.innerText = `SCORE: ${score}`;
                            
                            // 全滅チェック
                            if (checkWin()) {
                                alert("YOU WIN! 次のレベルへ");
                                resetGame();
                                enemySpeed += 1; // 初期スピードアップ
                            }
                            break; 
                    }
                }
            }
        }
    }

    // 勝利判定
    function checkWin() {
        return enemies.every(e => e.status === 0);
    }

    // ゲームオーバー処理
    function gameOver() {
        gameState = 'GAMEOVER';
        statusText.innerText = `GAME OVER - Score: ${score} (Press Space)`;
    }

    // --- 描画処理 ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // プレイヤー描画（画像に変更）
        // ctx.drawImage(画像, x, y, 幅, 高さ)
        ctx.drawImage(playerImage, player.x, player.y, player.width, player.height);

        // 弾描画
        ctx.fillStyle = '#ffff00';
        for (let b of player.bullets) {
            ctx.fillRect(b.x, b.y, b.width, b.height);
        }

        // 敵描画
        ctx.fillStyle = '#ff3333';
        for (let e of enemies) {
            if (e.status === 1) {
                // シンプルなインベーダー（四角形）
                ctx.fillRect(e.x, e.y, enemyWidth, enemyHeight);
                // 目を描く（かわいく）
                ctx.fillStyle = 'black';
                ctx.fillRect(e.x + 5, e.y + 5, 5, 5);
                ctx.fillRect(e.x + 20, e.y + 5, 5, 5);
                ctx.fillStyle = '#ff3333'; // 色を戻す
            }
        }

        // スタート/ゲームオーバー画面のオーバーレイ
        if (gameState === 'START') {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.font = '30px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText("SPACE INVADERS", canvas.width/2, canvas.height/2 - 20);
            ctx.font = '20px Courier New';
            ctx.fillText("Press SPACE to Start", canvas.width/2, canvas.height/2 + 20);
        } else if (gameState === 'GAMEOVER') {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'red';
            ctx.font = '40px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2);
            ctx.fillStyle = 'white';
            ctx.font = '20px Courier New';
            ctx.fillText(`Final Score: ${score}`, canvas.width/2, canvas.height/2 + 40);
        }
    }

    // --- メインループ ---
    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    // ゲーム開始
    gameLoop();

</script>
</body>
</html>